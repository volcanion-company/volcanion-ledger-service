# Code Review

## Critical
- Ledger transactions are never persisted. Each command handler builds a transaction in-memory via `account.Topup/ProcessPayment/ProcessRefund/ApplyAdjustment` and reads `account.Transactions.Last()`, but nothing ever calls `ILedgerTransactionRepository.AddAsync` and EF explicitly ignores `Account.Transactions`, so no rows can reach `ledger_transactions` (breaking history/idempotency and audit). See [src/Volcanion.LedgerService.Application/Commands/Transactions/TopupCommandHandler.cs#L85](src/Volcanion.LedgerService.Application/Commands/Transactions/TopupCommandHandler.cs#L85), [src/Volcanion.LedgerService.Application/Commands/Transactions/ProcessPaymentCommandHandler.cs#L99](src/Volcanion.LedgerService.Application/Commands/Transactions/ProcessPaymentCommandHandler.cs#L99), [src/Volcanion.LedgerService.Application/Commands/Transactions/ProcessRefundCommandHandler.cs#L93](src/Volcanion.LedgerService.Application/Commands/Transactions/ProcessRefundCommandHandler.cs#L93), [src/Volcanion.LedgerService.Application/Commands/Transactions/ApplyAdjustmentCommandHandler.cs#L83](src/Volcanion.LedgerService.Application/Commands/Transactions/ApplyAdjustmentCommandHandler.cs#L83) and the mapping that drops the navigation at [src/Volcanion.LedgerService.Infrastructure/Persistence/Configurations/AccountConfiguration.cs#L110](src/Volcanion.LedgerService.Infrastructure/Persistence/Configurations/AccountConfiguration.cs#L110).

## Major
- Transaction history paging is done in-memory for type and date filters, pulling full datasets before `Skip/Take`, and the date branch lacks ordering, so results can be slow, inconsistent, and incorrectly paged on large accounts. See [src/Volcanion.LedgerService.Application/Queries/Transactions/GetTransactionHistoryQueryHandler.cs#L43-L72](src/Volcanion.LedgerService.Application/Queries/Transactions/GetTransactionHistoryQueryHandler.cs#L43-L72).
- Idempotency expiry is never enforced. Although `ExpiresAt` is set when storing records, retrieval returns cached responses unconditionally, so stale responses can block reprocessing past TTL. See [src/Volcanion.LedgerService.Application/Behaviors/IdempotencyBehavior.cs#L62-L74](src/Volcanion.LedgerService.Application/Behaviors/IdempotencyBehavior.cs#L62-L74) and [src/Volcanion.LedgerService.Application/Behaviors/IdempotencyBehavior.cs#L96](src/Volcanion.LedgerService.Application/Behaviors/IdempotencyBehavior.cs#L96).
- CORS fallback is invalid: `policy.WithOrigins()` is called with no origins when config is empty, which throws at startup. Replace with an explicit deny/allow policy (e.g., `AllowAnyOrigin` or fail fast). See [src/Volcanion.LedgerService.API/Program.cs#L97](src/Volcanion.LedgerService.API/Program.cs#L97).

## Minor
- Idempotency writes bypass the unit-of-work transaction (`IdempotencyRepository` calls `SaveChangesAsync` on its own context), so if persisting the idempotency record fails, the request still returns success but future retries wont be deduped. Consider joining the main transaction or surfacing the failure. See [src/Volcanion.LedgerService.Infrastructure/Persistence/Repositories/IdempotencyRepository.cs#L45](src/Volcanion.LedgerService.Infrastructure/Persistence/Repositories/IdempotencyRepository.cs#L45).
